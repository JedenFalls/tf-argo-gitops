apiVersion: batch/v1
kind: Job
metadata:
  name: service01-tf-apply
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      restartPolicy: Never

      volumes:
      - name: shared-data
        emptyDir: {} 
      
      initContainers:
      - name: tf-init
        image: adhocam/azurerm:6
        imagePullPolicy: Never
        command:
        - sh
        - "-c"
        - |
          cd /terraform/service01
          terraform init
          cp -r /terraform /iac
          ls /iac/terraform -al
        volumeMounts:
        - mountPath: /iac
          name: shared-data

      containers:
      - name: tf-apply
        image: adhocam/azurerm:6
        imagePullPolicy: Never
        command:
        - sh
        - "-c"
        - |
          cd iac/terraform/service01
          terraform apply -auto-approve
        envFrom:
        - secretRef:
            name: azcreds
        volumeMounts:
        - mountPath: /iac
          name: shared-data     

  backoffLimit: 0